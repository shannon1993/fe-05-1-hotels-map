var app=app||{};app.init=function(){app.model=new app.Hotel,app.vm=new app.ViewModel,app.mv=new app.MapView,app.model.init(),ko.applyBindings(app.vm)},app.errorHandler=function(e){var t=document.getElementById("map");t.innerHTML="There was an error loading the "+e+" script."};var $jsonp=function(){var e={};return e.send=function(e,t){var o=t||{},n=o.callbackName||"callback",a=o.onSuccess||function(){},r=o.onTimeout||function(){},i=o.timeout||10,s=o.data||{},l="?";for(var p in s)s.hasOwnProperty(p)&&(l+=encodeURIComponent(p)+"="+encodeURIComponent(s[p])+"&");var c=window.setTimeout(function(){window[n]=function(){},r()},1e3*i);window[n]=function(e){window.clearTimeout(c),a(e)};var u=document.createElement("script");u.type="text/javascript",u.async=!0,u.src=e+l,document.getElementsByTagName("head")[0].appendChild(u)},e}(),AJAX=function(){var e={};return e.xhr=null,e.isJSONSupported=function(){if("undefined"==typeof XMLHttpRequest)return!1;var e=new XMLHttpRequest;e.open("get","/",!0);try{e.responseType="json"}catch(t){return!1}return"response"in e&&"json"==e.responseType},e.request=function(t,o,n,a,r){this.xhr||(this.xhr=new XMLHttpRequest);var i=this.xhr;if(null!==n){var s="?"+Object.keys(n).map(function(e){return e+"="+encodeURIComponent(n[e])}).join("&");t+=s}window.console&&console.log("AJAX "+o+" request: "+t),i.onload=function(e){var t="";"json"===e.target.responseType?(t=e.target.response,a(t)):(t=JSON.parse(e.target.responseText),a(t)),window.console&&console.log("AJAX onload event called with status: "+e.target.status+" "+e.target.statusText)},i.onerror=function(){r(),window.console&&console.log("AJAX onerror event called with status: "+i.status+" "+i.statusText)},i.onreadystatechange=function(){var e="";switch(i.readyState){case 0:e="UNSENT";break;case 1:e="OPENED";break;case 2:e="HEADERS_RECEIVED";break;case 3:e="LOADING";break;case 4:e="DONE"}window.console&&console.log("AJAX onreadystatechange event called with readyState: "+e)},e.supportsJSON=e.isJSONSupported(),e.xhr.open(o,t,!0),e.supportsJSON&&(e.xhr.responseType="json"),e.xhr.send()},e}(),app=app||{};app.Hotel=function(){"use strict";var e=this;e.hotels=ko.observableArray(),e.yelp={},e.init=function(){var t,o,n=0,a=[],r=0;e.reqTimeout(),t=new Firebase("https://crackling-heat-3113.firebaseio.com"),t.once("value",function(t){for(e.yelp=t.child("yelp").val(),o=t.child("hotels").val(),r=o.length,n;r>n;n++)a=o[n],a.content=null,a.tweets=null,e.hotels.push(a);app.vm.init()},function(e){var t="Error code: "+e.code+". <br>";t+="You do not have permission to read hotel data. Please contact the webmaster to gain access.",app.vm.dispMsg(t)})},e.reqTimeout=function(){var t="Firebase server request timed out. <br> Check your connection and refresh the page.";setTimeout(function(){0===e.hotels().length&&(app.vm.timeout(!0),app.vm.dispMsg(t))},1e4)}};var app=app||{};app.ViewModel=function(){"use strict";var e=this;e.showTicker=ko.observable(!1),e.hotelTweets=ko.observable(""),e.timeout=ko.observable(!1),e.dispMsg=ko.observable(""),e.hotelList=ko.observableArray(),e.filterList=ko.observableArray(),e.filterText=ko.observable(""),e.ratingsChecked=ko.observableArray(),e.ratings=ko.observableArray([{ratingValue:5,icon:"aaaaa",color:"red"},{ratingValue:4,icon:"aaaa",color:"yellow"},{ratingValue:3,icon:"aaa",color:"green"},{ratingValue:2,icon:"aa",color:"purple"}]),e.slideClass=ko.observable("hidden overlay"),e.showDef=ko.observable(!1),e.showName=ko.observable(!0),e.showRating=ko.observable(!1),e.showList=ko.observable(!0),e.getRatings=function(){return e.ratings()},e.nameSort=function(e,t){return e.name==t.name?0:e.name<t.name?-1:1},e.getHotels=ko.computed(function(){var t=app.model.hotels();return t.sort(e.nameSort),t}),e.getHotelsLength=ko.computed(function(){return app.model.hotels().length}),e.getKeys=function(){return app.model.yelp},e.init=function(){e.hotelList(e.getHotels()),app.mv.initMap()},e.slideIn=function(){e.slideClass("animated slideInLeft no-overlay"),e.centerPanMap()},e.slideOut=function(){e.slideClass("animated fadeOutLeft overlay"),e.centerPanMap()},e.centerPanMap=function(){google.maps.event.trigger(app.mv.map,"resize"),app.mv.currentLocation&&app.mv.map.setCenter(app.mv.currentLocation),window.screen.height>400&&window.screen.width<415&&app.mv.map.panBy(0,-120)},e.noEnter=function(e,t){return!1},e.gotoHotel=function(e){window.screen.height>400&&window.screen.width<415&&app.mv.map.panBy(0,-120),app.mv.infoWindow.close(),google.maps.event.trigger(e.marker,"click")},e.filterRatings=function(t,o){return e.hotelDisplay(),!0},e.toggleName=function(){e.showName(!e.showName())},e.toggleRating=function(){e.showRating(!e.showRating())},e.toggleList=function(){e.showList(!e.showList())},e.toggleDef=function(){e.showDef(!e.showDef())},e.hotelDisplay=ko.computed(function(){var t=-1,o=[],n=e.filterText().toLowerCase(),a=e.ratingsChecked().length,r=0,i=-1;return e.showTicker(!1),e.filterList(e.hotelList()),!n&&0>=a?(e.filterList().forEach(function(e,t){e.marker&&e.marker.setVisible(!0)}),e.filterList):(e.filterList().forEach(function(s,l){t=s.name.toLowerCase().indexOf(n),r=s.diamonds,i=a>0?e.ratingsChecked.indexOf(r):0,t>=0&&i>=0?(s.marker.setVisible(!0),o.push(s)):(s.marker.setVisible(!1),app.mv.infoWindow.close())}),e.filterList(o),e.filterList)})};var app=app||{};app.MapView=function(){"use strict";var e=this;e.infoWindow=null,e.currentLocation=null,e.originalMapCenter={lat:36.1049534,lng:-115.1724043},e.mapDiv=document.getElementById("map"),e.mapOptions={disableDefaultUI:!0,center:e.originalMapCenter,zoom:15,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},e.preload='<div class="preload">Loading...<div class="spin"></div></div>',e.markerUrl="http://maps.google.com/mapfiles/ms/icons/",e.markerColors=["pink","blue","purple","green","yellow","red"],e.bounds=new google.maps.LatLngBounds,e.initMap=function(){e.map=new google.maps.Map(e.mapDiv,e.mapOptions),e.infoWindow=new google.maps.InfoWindow,e.createMarkers(),google.maps.event.addDomListener(window,"resize",function(){var t=e.map.getCenter();google.maps.event.trigger(e.map,"resize"),e.map.setCenter(t)})},e.createMarkers=function(){var t=0,o={},n=app.vm.getHotels(),a=app.vm.getHotelsLength();for(t;a>t;t++)o=n[t],o.color=e.markerColors[o.diamonds],o.marker=new google.maps.Marker({map:e.map,position:o.location,title:o.name,animation:null,visible:!0,icon:e.markerUrl+o.color+".png"}),e.bounds.extend(new google.maps.LatLng(o.location)),e.setInfoWin(o);e.map.fitBounds(e.bounds)},e.animateMarker=function(t){t.marker.setAnimation(google.maps.Animation.BOUNCE),t.marker.icon=e.markerUrl+t.color+"-dot.png",setTimeout(function(){t.marker.setAnimation(null),t.marker.icon=e.markerUrl+t.color+".png"},2100)},e.setInfoWin=function(t){google.maps.event.addListener(t.marker,"click",function(){t.content?e.infoWindow.setContent(t.content):(e.infoWindow.setContent(e.preload),e.getContent(t)),e.infoWindow.open(e.map,t.marker),e.animateMarker(t),e.currentLocation=t.location,t.tweets?e.displayTweets(t.tweets):e.getTweets(t),e.map.setCenter(t.location),window.screen.height>400&&window.screen.width<415&&e.map.panBy(0,-120)})},e.getContent=function(t){function o(){return Math.floor(1e12*Math.random()).toString()}var n="http://api.yelp.com/v2/business/"+t.id,a=app.vm.getKeys(),r={oauth_consumer_key:a.CONSUMER_KEY,oauth_token:a.TOKEN,oauth_nonce:o(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb"},i=oauthSignature.generate("GET",n,r,a.CONSUMER_SECRET,a.TOKEN_SECRET);r.oauth_signature=i,$jsonp.send(n,{callbackName:"cb",data:r,onSuccess:function(o){t.content=e.getTemplate(t.name,t.diamonds,o.image_url,o.snippet_text,o.url),e.infoWindow.setContent(t.content)},onTimeout:function(){t.content=null,e.infoWindow.setContent("Error retrieving Yelp data.<br>Please try again.")},timeout:5})},e.getTemplate=function(e,t,o,n,a){var r=0,i=app.vm.getRatings(),s=i.length,l="",p="";for(r;s>r;r++)if(i[r].ratingValue===t){p=i[r].icon;break}return l="<h4>"+e+"</h4>",l+='<i class="diamonds small">'+p+"</i>",l+='<div class="gm-info-container">',l+='  <div class="gm-info-image"><img src="'+o+'" alt="'+e+'"></div>',l+='  <div class="gm-info-text">',l+='<img src="images/yelp_reviews.png" alt="Yelp Reviews"><br>',l+=n+' <a href="'+a+'">read more</a>',l+="  </div>",l+="</div>"},e.getTweets=function(t){var o="http://topwidget.co/twitter/api.php",n={screen_name:t.twitter,count:5};AJAX.request(o,"GET",n,function(o){var n="",a=o.length,r=0,i="",s="",l="",p="https://twitter.com/"+t.twitter+"/status/";for(r;a>r;r++)l=o[r].id_str,i=o[r].text,s=o[r].user.profile_image_url,n+='<li class="tweet">',n+='<a href="'+p+l+'" title="@'+t.twitter+'" target="_blank">',n+='<img src="'+s+'" alt="@'+t.twitter+'"> ',n+=i+"</a>",n+="</li>";t.tweets=n,e.displayTweets(t.tweets)},function(){var o="https://twitter.com/"+t.twitter,n='<li><a href="'+o+'" target="_blank">Failed to load recent tweets for @';n+=t.twitter+". Click here to view tweets on twitter.com.</a></li>",t.tweets=null,e.displayTweets(n),window.console&&console.log("AJAX GET request failed.")})},e.displayTweets=function(e){app.vm.showTicker(!0),app.vm.hotelTweets(e)}};