var app=app||{};app.init=function(){app.model=new app.Hotel,app.vm=new app.ViewModel,app.hv=new app.HotelView,app.mv=new app.MapView,app.model.init(),app.hv.init(),ko.applyBindings(app.vm)},app.errorHandler=function(e){var t=document.getElementById("map");t.innerHTML="There was an error loading the "+e+" script."},app.Hotel=function(){"use strict";var e=this;e.hotels=ko.observableArray(),e.yelp={},e.init=function(){var t,n,o=0,a=[],i=0;e.reqTimeout(),t=new Firebase("https://crackling-heat-3113.firebaseio.com"),t.once("value",function(t){for(e.yelp=t.child("yelp").val(),n=t.child("hotels").val(),i=n.length,o;i>o;o++)a=n[o],a.content=null,a.tweets=null,e.hotels.push(a);app.vm.init()},function(e){var t="Could not load hotel data. The read failed with error code: ";t+=e.code+". Please contact the webmaster.",document.getElementById("map").innerHTML=t})},e.reqTimeout=function(){var e=document.getElementById("map"),t="Map request timed out. Check your connection and refresh the page.";setTimeout(function(){"FIGCAPTION"===e.children[0].nodeName&&(e.innerHTML=t)},1e4)}},app.ViewModel=function(){"use strict";var e=this;e.hotelList=ko.observableArray(),e.filterList=ko.observableArray(),e.filterText=ko.observable(""),e.ratingsChecked=ko.observableArray(),e.ratings=ko.observableArray([{ratingValue:5,icon:"aaaaa",color:"red"},{ratingValue:4,icon:"aaaa",color:"yellow"},{ratingValue:3,icon:"aaa",color:"green"},{ratingValue:2,icon:"aa",color:"purple"}]),e.getRatings=function(){return e.ratings()},e.nameSort=function(e,t){return e.name==t.name?0:e.name<t.name?-1:1},e.getHotels=ko.computed(function(){var t=app.model.hotels();return t.sort(e.nameSort),t}),e.getHotelsLength=ko.computed(function(){return app.model.hotels().length}),e.getKeys=function(){return app.model.yelp},e.init=function(){e.hotelList(e.getHotels()),app.mv.initMap()},e.slideIn=function(){app.hv.slideInLeft(),google.maps.event.trigger(app.mv.map,"resize")},e.slideOut=function(){app.hv.slideOutLeft(),google.maps.event.trigger(app.mv.map,"resize"),app.mv.map.setCenter(app.mv.currentLocation),window.screen.height>400&&app.mv.map.panBy(0,-120)},e.noEnter=function(e,t){return!1},e.gotoHotel=function(e){app.mv.map.setCenter(e.location),window.screen.height>400&&app.mv.map.panBy(0,-120),app.mv.infoWindow.close(),google.maps.event.trigger(e.marker,"click")},e.filterRatings=function(t,n){return e.hotelDisplay(),!0},e.open=function(){app.hv.openInfo()},e.close=function(){app.hv.closeInfo()},e.hotelDisplay=ko.computed(function(){var t=-1,n=[],o=e.filterText().toLowerCase(),a=e.ratingsChecked().length,i=0,r=-1;return document.getElementById("twitter").innerHTML="",e.filterList(e.hotelList()),!o&&0>=a?(e.filterList().forEach(function(e,t){e.marker&&e.marker.setVisible(!0)}),e.filterList):(e.filterList().forEach(function(s,l){t=s.name.toLowerCase().indexOf(o),i=s.diamonds,r=a>0?e.ratingsChecked.indexOf(i):0,t>=0&&r>=0?(s.marker.setVisible(!0),n.push(s)):(s.marker.setVisible(!1),app.mv.infoWindow.close())}),e.filterList(n),e.filterList)})},app.HotelView=function(){"use strict";var e=this;e.slide=document.getElementById("slide"),e.animateIn="animated slideInLeft no-overlay",e.animateOut="animated fadeOutLeft overlay",e.h3=document.getElementsByTagName("h3"),e.def=document.getElementById("definitions"),e.slideInLeft=function(){e.slide.className=e.animateIn},e.slideOutLeft=function(){e.slide.className=e.animateOut},e.openInfo=function(){e.def.style.display="block"},e.closeInfo=function(){e.def.style.display=""},e.toggleDisplay=function(e,t){return"icons icon-down"!=t?(t="icons icon-down",e.nextElementSibling.style.display="block"):(t="icons icon-right",e.nextElementSibling.style.display="none"),t},e.setIcon=function(t){var n;n="H3"===t.target.nodeName?t.target:t.target.parentNode,n.firstChild.className=e.toggleDisplay(n,n.firstChild.className)},e.init=function(){var t=0,n=e.h3.length;for(t;n>t;t++)e.h3[t].addEventListener("click",e.setIcon,!1)}},app.MapView=function(){"use strict";var e=this;e.infoWindow=null,e.currentLocation=null,e.currentMapCenter=null,e.originalMapCenter={lat:36.1049534,lng:-115.1724043},e.mapDiv=document.getElementById("map"),e.mapOptions={disableDefaultUI:!0,center:e.originalMapCenter,zoom:15,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},e.preload='<div class="preload">Loading...<div class="spin"></div></div>',e.markerUrl="http://maps.google.com/mapfiles/ms/icons/",e.markerColors=["pink","blue","purple","green","yellow","red"],e.initMap=function(){e.map=new google.maps.Map(e.mapDiv,e.mapOptions),e.infoWindow=new google.maps.InfoWindow,e.createMarkers(),google.maps.event.addDomListener(window,"resize",function(){google.maps.event.trigger(e.map,"resize")}),google.maps.event.addListener(e.map,"resize",function(){e.currentMapCenter=e.map.getCenter(),e.map.setCenter(e.currentMapCenter)})},e.createMarkers=function(){var t=0,n={},o=app.vm.getHotels(),a=app.vm.getHotelsLength();for(t;a>t;t++)n=o[t],n.color=e.markerColors[n.diamonds],n.marker=new google.maps.Marker({map:e.map,position:n.location,title:n.name,animation:null,visible:!0,icon:e.markerUrl+n.color+".png"}),e.setInfoWin(n)},e.animateMarker=function(t){t.marker.setAnimation(google.maps.Animation.BOUNCE),t.marker.icon=e.markerUrl+t.color+"-dot.png",setTimeout(function(){t.marker.setAnimation(null),t.marker.icon=e.markerUrl+t.color+".png"},2100)},e.setInfoWin=function(t){google.maps.event.addListener(t.marker,"click",function(){t.content?e.infoWindow.setContent(t.content):(e.infoWindow.setContent(e.preload),e.getContent(t)),e.infoWindow.open(e.map,t.marker),e.animateMarker(t),e.currentLocation=t.location,t.tweets?e.displayTweets(t.tweets):e.getTweets(t)})},e.getContent=function(t){function n(){return Math.floor(1e12*Math.random()).toString()}var o="http://api.yelp.com/v2/business/"+t.id,a=app.vm.getKeys(),i={oauth_consumer_key:a.CONSUMER_KEY,oauth_token:a.TOKEN,oauth_nonce:n(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb"},r=oauthSignature.generate("GET",o,i,a.CONSUMER_SECRET,a.TOKEN_SECRET);i.oauth_signature=r,$jsonp.send(o,{callbackName:"cb",data:i,onSuccess:function(n){t.content=e.getTemplate(t.name,t.diamonds,n.image_url,n.snippet_text,n.url),e.infoWindow.setContent(t.content)},onTimeout:function(){t.content=null,e.infoWindow.setContent("Error retrieving Yelp data.<br>Please try again.")},timeout:5})},e.getTemplate=function(e,t,n,o,a){var i=0,r=app.vm.getRatings(),s=r.length,l="",p="";for(i;s>i;i++)if(r[i].ratingValue===t){p=r[i].icon;break}return l="<h4>"+e+"</h4>",l+='<i class="diamonds small">'+p+"</i>",l+='<div class="gm-info-container">',l+='  <div class="gm-info-image"><img src="'+n+'" alt="'+e+'"></div>',l+='  <div class="gm-info-text">',l+='<img src="images/yelp_reviews.png" alt="Yelp Reviews"><br>',l+=o+' <a href="'+a+'">read more</a>',l+="  </div>",l+="</div>"},e.getTweets=function(t){var n="http://topwidget.co/twitter/api.php",o={screen_name:t.twitter,count:5};AJAX.request(n,"GET",o,function(n){var o="",a=n.length,i=0,r="",s="",l="",p="https://twitter.com/"+t.twitter+"/status/";for(i;a>i;i++)l=n[i].id_str,r=n[i].text,s=n[i].user.profile_image_url,o+='<li class="tweet">',o+='<a href="'+p+l+'" title="@'+t.twitter+'" target="_blank">',o+='<img src="'+s+'" alt="@'+t.twitter+'"> ',o+=r+"</a>",o+="</li>";t.tweets=o,e.displayTweets(t.tweets)},function(){t.tweets=null,window.console&&console.log("AJAX request failed.")})},e.displayTweets=function(e){var t=document.getElementById("twitter");t.innerHTML=e}};var $jsonp=function(){var e={};return e.send=function(e,t){var n=t||{},o=n.callbackName||"callback",a=n.onSuccess||function(){},i=n.onTimeout||function(){},r=n.timeout||10,s=n.data||{},l="?";for(var p in s)s.hasOwnProperty(p)&&(l+=encodeURIComponent(p)+"="+encodeURIComponent(s[p])+"&");var c=window.setTimeout(function(){window[o]=function(){},i()},1e3*r);window[o]=function(e){window.clearTimeout(c),a(e)};var u=document.createElement("script");u.type="text/javascript",u.async=!0,u.src=e+l,document.getElementsByTagName("head")[0].appendChild(u)},e}(),AJAX=function(){var e={};return e.xhr=null,e.isJSONSupported=function(){if("undefined"==typeof XMLHttpRequest)return!1;var e=new XMLHttpRequest;e.open("get","/",!0);try{e.responseType="json"}catch(t){return!1}return"response"in e&&"json"==e.responseType},e.request=function(t,n,o,a,i){this.xhr||(this.xhr=new XMLHttpRequest);var r=this.xhr;if(null!==o){var s="?"+Object.keys(o).map(function(e){return e+"="+encodeURIComponent(o[e])}).join("&");t+=s}window.console&&console.log("AJAX "+n+" request: "+t),r.onload=function(e){var t="";"json"===e.target.responseType?(t=e.target.response,a(t)):(t=JSON.parse(e.target.responseText),a(t)),window.console&&console.log("AJAX onload event called with status: "+e.target.status+" "+e.target.statusText)},r.error=function(){i(),window.console&&console.log("AJAX error event called with status: "+r.status+" "+r.statusText)},r.onreadystatechange=function(){var e="";switch(r.readyState){case 0:e="UNSENT";break;case 1:e="OPENED";break;case 2:e="HEADERS_RECEIVED";break;case 3:e="LOADING";break;case 4:e="DONE"}window.console&&console.log("AJAX onreadystatechange event called with readyState: "+e)},e.supportsJSON=e.isJSONSupported(),e.xhr.open(n,t,!0),e.supportsJSON&&(e.xhr.responseType="json"),e.xhr.send()},e}();